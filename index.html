<html>
<head>
<meta charset=utf-8 />
<title>to-fix</title>
<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
<script src='//api.tiles.mapbox.com/mapbox.js/v1.6.4/mapbox.js'></script>
<script src='//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js'></script>
<script src='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.2.0/leaflet-omnivore.min.js'></script>
<script src='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-osm/v0.1.0/leaflet-osm.js'></script>
<link href='//api.tiles.mapbox.com/mapbox.js/v1.6.4/mapbox.css' rel='stylesheet' />
<link href='//www.mapbox.com/base/latest/base.css' rel='stylesheet'>
<style>
    body {
        margin:0;
        padding:0;
    }

    #map {
        position:absolute;
        top:0;
        bottom:0;
        width:100%;
    }

    h1:hover {
        cursor: pointer;
    }

    .controls {
        float: left;
        position: absolute;
        background-color: white;
        z-index: 9001;
        font-weight: bold;
    }

    #title {
        left: 48px;
        top: 10px;
        padding: 0px 15px;
        line-height: 54px;
    }

    #menu {
        width: 250px;
        top: 64px;
        left: 48px;
        padding: 10px 0;
        float: left;
        position: absolute;
        background-color: white;
        z-index: 9001;
        font-weight: bold;
    }

    #menu a {   
        line-height: 2em;
        float: left;
        width: 100%;
        padding: 0 15px;
    }

    #next {
        padding: 0px 100px;
        line-height: 55px;
        font-size: 20px;
        bottom: 30px;
        right: 10px;
        font-weight: bold;
    }

    #next:hover {
        cursor: pointer;
    }

    .leaflet-bar, .leaflet-control-layers {
        border-radius: 0px;
        border-color: rgba(0,0,0,0);
    }

    .leaflet-bar a, .leaflet-bar a:hover {
        border-bottom: none;
        border-bottom-color: rgba(0,0,0,0);
    }
</style>
</head>
<body>

<h1 id='title' class='controls hidden'></h1>
<div id='menu' class='hidden'></div>
<div id='next' class='controls hidden'>Next Â»</div>

<div id='map'></div>
<script>
    var title = {
        'keepright/deadendoneway': 'One-way without exit',
        // 'keepright/highwaywater': 'Highways crossing water',
        'keepright/impossibleangle': 'Sharp angles',
        'keepright/mixedlayer': 'Mixed layer tagging',
        'keepright/nonclosedways': 'Nonclosed ways'
        // don't forget osmi
    };

    var url = 'http://54.91.116.141:3000/error/';

    function qs(name) {
        name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
        var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
            results = regex.exec(location.search);
        return results == null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
    }

    var map = L.mapbox.map('map', 'aaronlidman.inhj344j').setView([22.76, -25.84], 3);

    $(function() {
        renderMenu();
        load();
    });

    if (qs('error') == '') window.location.href = window.location.href + '?error=' + Object.keys(title)[0];

    function load() {
        $.ajax({
            crossDomain: true,
            url: url + qs('error')
        }).done(function(data) {
            loader[qs('error')](data, function() {
                // idk
            });
        });
    }

    var loader = {};
    loader['keepright/deadendoneway'] = keeprights;
    loader['keepright/highwaywater'] = keeprights;
    loader['keepright/impossibleangle'] = keeprights;
    loader['keepright/mixedlayer'] = keeprights;
    loader['keepright/nonclosedways'] = keeprights;

    function keeprights(data, cb) {
        data = JSON.parse(data);
        console.log(data);
        var full = data.object_type == 'way' ? '/full' : '';
        $.ajax({
            url: 'https://www.openstreetmap.org/api/0.6/' + data.object_type + '/' + data.object_id + full,
            dataType: "xml",
            success: function (xml) {
                var layer = new L.OSM.DataLayer(xml).addTo(map);
                var bounds = layer.getBounds();
                console.log(bounds);
                map.fitBounds(bounds);
                if (map.getZoom() > 18) map.setZoom(18);
                omnivore.wkt.parse(data.st_astext).addTo(map);
                // open in JOSM
            }
        });
        cb();
        renderUI({
            title: title[qs('error')]
        });
    }

    function renderUI(data) {
        $('.controls').addClass('hidden');
        if (data.title) $('#title').html(data.title);
        if (data.josm) $('#josm').html(data.josm);
        $('.controls').removeClass('hidden');
    }

    $('h1').on('click', function() {
        if ($('#menu').hasClass('hidden')) {
            $('#menu').removeClass('hidden');
        } else {
            $('#menu').addClass('hidden');
        }
    });

    $('#next').on('click', function() {
        load();
    });

    function renderMenu() {
        var html = '';
        for (var item in title) {
            if (item != qs('error')) html += '<a href="' + window.location.href.split(qs('error')).join(item) + '">' + title[item] + '</a>';
        }
        $('#menu').html(html);
    }

    // autoload JOSM
    // no user anything yet

</script>

</body>
</html>
