<html>
<head>
<meta charset=utf-8 />
<title>to-fix</title>
<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
<script src='http://api.tiles.mapbox.com/mapbox.js/v1.6.4/mapbox.js'></script>
<script src='http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js'></script>
<script src='http://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.2.0/leaflet-omnivore.min.js'></script>
<script src='http://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-osm/v0.1.0/leaflet-osm.js'></script>
<script src='./bing.js'></script>
<script src='./osmauth.min.js'></script>
<link href='http://api.tiles.mapbox.com/mapbox.js/v1.6.4/mapbox.css' rel='stylesheet' />
<link href='http://www.mapbox.com/base/latest/base.css' rel='stylesheet'>
<style>
    body {
        margin: 0;
        padding: 0;
    }

    #map {
        position:absolute;
        top:0;
        bottom:0;
        width:100%;
    }

    h1:hover, .controls:hover {
        cursor: pointer;
    }

    .controls, #login {
        float: left;
        position: absolute;
        background-color: white;
        z-index: 9001;
        font-weight: bold;
    }

    #title {
        left: 48px;
        top: 10px;
        padding: 0px 15px;
        line-height: 54px;
    }

    #menu {
        width: 250px;
        top: 64px;
        left: 48px;
        padding: 10px 0;
        float: left;
        position: absolute;
        background-color: white;
        z-index: 9001;
        font-weight: bold;
    }

    #menu a {   
        line-height: 2em;
        float: left;
        width: 100%;
        padding: 0 15px;
    }

    #next, #josm {
        text-align: center;
        width: 250px;
        line-height: 55px;
        font-size: 20px;
        bottom: 30px;
        right: 10px;
        font-weight: bold;
    }

    #josm {
        bottom: 90px;
    }

    #login {
        cursor: pointer;
        padding: 15px 20px;
        text-align: center;
        height: 50px;
        font-size: 20px;
        letter-spacing: -1px;
        bottom: 10px;
        left: 10px;
    }

    .leaflet-bar, .leaflet-control-layers {
        border-radius: 0px;
        border-color: rgba(0,0,0,0);
    }

    .leaflet-bar a, .leaflet-bar a:hover {
        border-bottom: none;
        border-bottom-color: rgba(0,0,0,0);
    }
</style>
</head>
<body>

<h1 id='title' class='controls hidden'></h1>
<div id='menu' class='hidden'></div>
<div id='login' class='hidden'>Login with your OSM account »</div>
<div id='josm' class='controls hidden'>load in JOSM</div>
<div id='next' class='controls hidden'>next »</div>

<div id='map'></div>
<script>
    var auth = osmAuth({
        oauth_consumer_key: 'KcVfjQsvIdd7dPd1IFsYwrxIUd73cekN1QkqtSMd',
        oauth_secret: 'K7dFg6rfIhMyvS8cPDVkKVi50XWyX0ibajHnbH8S',
        landing: location.href.replace('/index.html', '').replace(location.search, '') + '/land.html'
    });

    var title = {
        'deadendoneway': 'One-way without exit',
        // 'highwaywater': 'Highways crossing water',
        'impossibleangle': 'Sharp angles',
        'mixedlayer': 'Mixed layer tagging',
        'nonclosedways': 'Nonclosed ways',
        'unconnected_major1': 'Unconnected major < 1m',
        'unconnected_major2': 'Unconnected major < 2m',
        'unconnected_major5': 'Unconnected major < 5m',
        'unconnected_minor1': 'Unconnected minor < 1m',
        'unconnected_minor2': 'Unconnected minor < 2m'
        // 'tigerdelta': 'TIGER delta'
    };

    var url = 'http://54.82.204.158:3000/error/';
    // var url = 'http://localhost:3000/error/';
    var current = {};

    function qs(name) {
        name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
        var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
            results = regex.exec(location.search);
        return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
    }

    var map = L.mapbox.map('map', '', {
        fadeAnimation: false,
        zoomAnimation: false,
        maxZoom: 18
    }).setView([22.76, -25.84], 3);

    var layers = {
        'Bing Satellite': new L.BingLayer('Arzdiw4nlOJzRwOz__qailc8NiR31Tt51dN2D7cm57NrnceZnCpgOkmJhNpGoppU'),
        'Mapbox Streets': L.mapbox.tileLayer('aaronlidman.inhj344j'),
        'Mapbox Satellite': L.mapbox.tileLayer('openstreetmap.map-inh7ifmo'),
        'OSM.org': L.tileLayer('http://a.tile.openstreetmap.org/{z}/{x}/{y}.png')
    };

    // set the initial baselayer
    var baseLayer = localStorage.getItem('baseLayer');
    var menuState = localStorage.getItem('menuState');

    if (baseLayer && layers[baseLayer]) {
        layers[baseLayer].addTo(map);
    } else {
        layers['Mapbox Streets'].addTo(map);
    }

    L.control.layers(layers).addTo(map);

    map.on('baselayerchange', function(e) {
        localStorage.setItem('baseLayer', e.name);
    });

    $('#login').on('click', function() {
        auth.authenticate(function(err) {
            if (err) return console.log(err);
            if (auth.authenticated()) {
                $('#login').addClass('hidden');
                load();
            }
        });
    });

    $(load);

    function load() {
        // if (auth.authenticated()) {
            renderMenu();
            if (qs('error') == '') {
                window.location.href = window.location.href + '?error=' + Object.keys(title)[0];
                // trailing slash from simplehttpserver is screwing things up
            }
            $.ajax({
                crossDomain: true,
                url: url + qs('error')
            }).done(function(data) {
                $('#map').removeClass('loading');
                loader[qs('error')](data);
            });
        // } else {
        //     $('#login').removeClass('hidden');
        // }
    }

    var loader = {};
    loader.deadendoneway = keeprights;
    loader.highwaywater = keeprights;
    loader.impossibleangle = keeprights;
    loader.mixedlayer = keeprights;
    loader.nonclosedways = keeprights;

    loader.unconnected_major1 = unconnected;
    loader.unconnected_major2 = unconnected;
    loader.unconnected_major5 = unconnected;
    loader.unconnected_minor1 = unconnected;
    loader.unconnected_minor2 = unconnected;

    loader.tigerdelta = tigerdelta;

    function keeprights(data) {
        data = JSON.parse(data);
        current = data;
        console.log(current);
        var full = data.object_type == 'way' ? '/full' : '';

        $.ajax({
            url: 'https://www.openstreetmap.org/api/0.6/' + data.object_type + '/' + data.object_id + full,
            dataType: "xml",
            success: function (xml) {
                var layer = new L.OSM.DataLayer(xml).addTo(map);
                current.bounds = layer.getBounds();
                map.fitBounds(current.bounds);
                omnivore.wkt.parse(data.st_astext).addTo(map);
            }
        });

        renderUI({
            title: title[qs('error')]
        });
    }

    function unconnected(data) {
        data = JSON.parse(data);
        current = data;
        // we're assuming they all have a node and a way, which might not hold true
        console.log(current);
        // first the way, then the node
        $.ajax({
            url: 'https://www.openstreetmap.org/api/0.6/way' + '/' + data.way_id + '/full',
            dataType: "xml",
            success: function (xml) {
                var layer = new L.OSM.DataLayer(xml).addTo(map);
                current.bounds = layer.getBounds();
                map.fitBounds(current.bounds);
                $.ajax({
                    url: 'https://www.openstreetmap.org/api/0.6/node' + '/' + data.node_id,
                    dataType: "xml",
                    success: function (xml) {
                        var layer = new L.OSM.DataLayer(xml).addTo(map);
                    }
                });
            }
        });
        renderUI({
            title: title[qs('error')]
        });
    }

    function tigerdelta(data) {
        data = JSON.parse(data);
        current = data;
        console.log(data);

        var layer = omnivore.wkt.parse(data.st_astext).addTo(map);
        current.bounds = layer.getBounds();
        map.fitBounds(current.bounds);

        // if (data.way) {
        //     $.ajax({
        //         url: 'https://www.openstreetmap.org/api/0.6/way' + '/' + data.way + '/full',
        //         dataType: "xml",
        //         success: function (xml) {
        //             var layer = new L.OSM.DataLayer(xml).addTo(map);
        //             current.bounds = layer.getBounds();
        //             map.fitBounds(current.bounds);
        //         }
        //     });
        // }

        renderUI({
            title: title[qs('error')]
        });
    }

    function loadJOSM() {
        var bottom = current.bounds._southWest.lat - 0.0005;
        var left = current.bounds._southWest.lng - 0.0005;
        var top = current.bounds._northEast.lat + 0.0005;
        var right = current.bounds._northEast.lng + 0.0005;
        $.ajax('http://localhost:8111/load_and_zoom?left=' + left + '&right=' + right + '&top=' + top + '&bottom=' + bottom + '&select=' + current.object_type + current.object_id);
    }

    function renderUI(data) {
        if (data.title) $('#title').html(data.title);
        $('.controls').removeClass('hidden');
    }

    $('h1').on('click', function() {
        if ($('#menu').hasClass('hidden')) {
            $('#menu').removeClass('hidden');
            localStorage.setItem('menuState', true);
            // no longer hidden
        } else {
            $('#menu').addClass('hidden');
            localStorage.setItem('menuState', 'hidden');
            // hidden
        }
    });

    $('#next').on('click', function() {
        $('#map').addClass('loading');
        load();
    });

    $('#josm').on('click', loadJOSM);

    function renderMenu() {
        var html = '';
        for (var item in title) {
            if (item != qs('error')) html += '<a href="' + window.location.href.split(qs('error')).join(item) + '">' + title[item] + '</a>';
        }
        $('#menu').html(html);
        if (localStorage.getItem('menuState') !== 'hidden') $('#menu').removeClass('hidden');
    }
</script>

</body>
</html>
